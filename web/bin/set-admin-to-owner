#!/bin/bash -eu
set -o pipefail

main() {
  initialize-environment-vars
  set-admin $(get-owner-secret)
  report-success
}

initialize-environment-vars() {
  readonly OWNER_FILE=$HOME/.wiki/localtest.me.owner.json
  readonly CONFIG_FILE=$HOME/.wiki/config.json
  readonly CONFIG_BACKUP_FILE=$CONFIG_FILE-saved-$(date --iso-8601=minutes)
}

get-owner-secret() {
  jq -r .friend.secret $OWNER_FILE
}

set-admin() {
  local SECRET=$1
  mv $CONFIG_FILE $CONFIG_BACKUP_FILE
  jq ".admin = \"$SECRET\"" $CONFIG_BACKUP_FILE > $CONFIG_FILE
}

report-success() {
  cat <<EOF
  Admin set to the owner in ${OWNER_FILE##$PWD/}
  Previous config is saved in ${CONFIG_BACKUP_FILE##$PWD/}

EOF
}

main "$@"
